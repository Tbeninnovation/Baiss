<Window
    x:Class="Baiss.UI.Views.MainWindow"
    x:Name="MainWin"
    xmlns="https://github.com/avaloniaui"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:li="using:LoadingIndicators.Avalonia"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:views="using:Baiss.UI.Views"
    xmlns:models="using:Baiss.UI.Models"
    xmlns:vm="using:Baiss.UI.ViewModels"
    xmlns:svg="using:Avalonia.Svg.Skia"
    xmlns:services="using:Baiss.UI.Services"
    xmlns:conv="using:Baiss.UI.Converters"
    Title="Baiss.UI.desktop"
    Width="1000"
    Height="750"
    Padding="0"
    d:DesignHeight="400"
    d:DesignWidth="400"
    x:DataType="vm:MainWindowViewModel"
    Background="#1a1a1a"
    ExtendClientAreaChromeHints="NoChrome"
    ExtendClientAreaTitleBarHeightHint="0"
    ExtendClientAreaToDecorationsHint="True"
    Icon="/Assets/logo.ico"
    DragDrop.AllowDrop="True"
    mc:Ignorable="d">

    <Window.Resources>
        <vm:BooleanNegationConverter x:Key="NegateBool" />
        <vm:MessageAlignmentConverter x:Key="MessageAlignmentConverter" />
        <vm:MessageWidthConverter x:Key="MessageWidthConverter" />
        <vm:MessageMaxWidthConverter x:Key="MessageMaxWidthConverter" />
        <vm:MessageBackgroundConverter x:Key="MessageBackgroundConverter" />
        <vm:NavigationBackgroundConverter x:Key="NavigationBackgroundConverter" />
        <vm:NavigationSecondaryForegroundConverter x:Key="NavigationSecondaryForegroundConverter" />
        <vm:ZeroToBoolConverter x:Key="ZeroToBoolConverter" />
        <vm:ZeroToBoolConverter x:Key="NonZeroToBoolConverter" Invert="True" />
        <vm:ExpandedToArrowConverter x:Key="ExpandedToArrowConverter" />
        <vm:FileNameConverter x:Key="FileNameConverter" />
        <vm:CopyButtonAlignmentConverter x:Key="CopyButtonAlignmentConverter" />
        <conv:ScopeEqualsConverter x:Key="ScopeEqualsConverter" />
        <DataTemplate x:Key="CompactChatModelTemplate" x:DataType="vm:AIModel">
            <TextBlock
                Text="{Binding ShortDisplayName}"
                FontSize="15"
                Foreground="#F9FAFB" />
        </DataTemplate>
    </Window.Resources>

    <Window.Styles>
        <Style Selector="ToggleButton.thinking-toggle">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderBrush" Value="Transparent" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="HorizontalContentAlignment" Value="Stretch" />
            <Setter Property="Padding" Value="0" />
            <Setter Property="Template">
                <ControlTemplate TargetType="ToggleButton">
                    <Border Background="{TemplateBinding Background}"
                            BorderBrush="{TemplateBinding BorderBrush}"
                            BorderThickness="{TemplateBinding BorderThickness}">
                        <ContentPresenter
                            HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                            VerticalAlignment="{TemplateBinding VerticalContentAlignment}"
                            Content="{TemplateBinding Content}"
                            ContentTemplate="{TemplateBinding ContentTemplate}" />
                    </Border>
                </ControlTemplate>
            </Setter>
        </Style>
        <Style Selector="ToggleButton.thinking-toggle:pointerover">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderBrush" Value="Transparent" />
        </Style>
        <Style Selector="ToggleButton.thinking-toggle:pressed">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderBrush" Value="Transparent" />
        </Style>
        <Style Selector="ToggleButton.thinking-toggle:checked">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderBrush" Value="Transparent" />
        </Style>
        <Style Selector="ComboBox.compact-model-select">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderBrush" Value="Transparent" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="Foreground" Value="#F9FAFB" />
            <Setter Property="FontSize" Value="15" />
            <Setter Property="Padding" Value="12,8,6,8" />
            <Setter Property="Height" Value="40" />
            <Setter Property="VerticalContentAlignment" Value="Center" />
        </Style>
        <Style Selector="ComboBox.compact-model-select:pointerover">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderBrush" Value="Transparent" />
            <Setter Property="BorderThickness" Value="0" />
        </Style>
        <Style Selector="ComboBox.compact-model-select:focus">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderBrush" Value="Transparent" />
            <Setter Property="BorderThickness" Value="0" />
        </Style>
        <Style Selector="ComboBox.compact-model-select:pressed">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderBrush" Value="Transparent" />
            <Setter Property="BorderThickness" Value="0" />
        </Style>
        <Style Selector="ComboBox.compact-model-select:dropdownopen">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderBrush" Value="Transparent" />
            <Setter Property="BorderThickness" Value="0" />
        </Style>
        <Style Selector="ComboBox.compact-model-select /template/ Border#Background">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderBrush" Value="Transparent" />
            <Setter Property="BorderThickness" Value="0" />
        </Style>
        <Style Selector="ComboBox.compact-model-select:pointerover /template/ Border#Background">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderBrush" Value="Transparent" />
            <Setter Property="BorderThickness" Value="0" />
        </Style>
        <Style Selector="ComboBox.compact-model-select:focus /template/ Border#Background">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderBrush" Value="Transparent" />
            <Setter Property="BorderThickness" Value="0" />
        </Style>
        <Style Selector="ComboBox.compact-model-select:pressed /template/ Border#Background">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderBrush" Value="Transparent" />
            <Setter Property="BorderThickness" Value="0" />
        </Style>
    </Window.Styles>

    <Border >
        <Grid>
            <!-- Toast Overlay Layer -->
            <Grid x:Name="ToastLayer" ZIndex="1000" IsHitTestVisible="False">
                <ItemsControl x:Name="ToastItems"
                              ItemsSource="{Binding Source={x:Static Member=views:MainWindow.ToastServiceInstance}, Path=Messages}"
                              HorizontalAlignment="Right"
                              VerticalAlignment="Top"
                              Margin="0,50,30,0">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate x:DataType="services:ToastMessage">
                            <Grid>
                                <!-- Success Toast -->
                                <Border Background="#43D590"
                                        CornerRadius="6"
                                        Padding="12,10"
                                        Margin="0,0,0,8"
                                        BorderBrush="#36B578"
                                        BorderThickness="1"
                                        Opacity="0.97"
                                        IsVisible="{Binding IsSuccessType}">
                                    <Grid ColumnDefinitions="Auto,*">
                                        <!-- Check Icon -->
                                        <Viewbox Grid.Column="0" Width="18" Height="18" Margin="0,0,10,0">
                                            <Path Fill="White"
                                                  Data="M9,0 L9,0 C13.97,0 18,4.03 18,9 C18,13.97 13.97,18 9,18 C4.03,18 0,13.97 0,9 C0,4.03 4.03,0 9,0 Z M7.5,12.5 L13.5,6.5 L12.09,5.09 L7.5,9.67 L5.91,8.09 L4.5,9.5 L7.5,12.5 Z" />
                                        </Viewbox>
                                        <TextBlock Grid.Column="1"
                                                  Text="{Binding Message}"
                                                  Foreground="White"
                                                  FontSize="15.2"
                                                  FontWeight="Medium"
                                                  TextWrapping="Wrap"
                                                  VerticalAlignment="Center"
                                                  MaxWidth="280"/>
                                    </Grid>
                                </Border>

                                <!-- Error Toast -->
                                <Border Background="#EC4B32"
                                        CornerRadius="6"
                                        Padding="12,10"
                                        Margin="0,0,0,8"
                                        BorderBrush="#D42525"
                                        BorderThickness="1"
                                        Opacity="0.97"
                                        IsVisible="{Binding IsErrorType}">
                                    <Grid ColumnDefinitions="Auto,*">
                                        <!-- X Icon -->
                                        <Border Grid.Column="0"
                                                Width="26"
                                                Height="26"
                                                Margin="0,0,10,0"
                                                Background="#a74628"
                                                CornerRadius="4"
                                                HorizontalAlignment="Center"
                                                VerticalAlignment="Center">
                                            <svg:Svg Path="/Assets/close.svg"
                                                     Width="18"
                                                     Height="18"
                                                     Stretch="Uniform"
                                                     HorizontalAlignment="Center"
                                                     VerticalAlignment="Center"
                                                     Css="svg path { stroke: white; }"/>

                                        </Border>
                                        <TextBlock Grid.Column="1"
                                                  Text="{Binding Message}"
                                                  Foreground="White"
                                                  FontSize="15.2"
                                                  FontWeight="Medium"
                                                  TextWrapping="Wrap"
                                                  VerticalAlignment="Center"
                                                  MaxWidth="280"/>
                                    </Grid>
                                </Border>
                            </Grid>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </Grid>

            <!--  Resize borders  -->
            <Border
                Name="TopResizeBorder"
                Height="6"
                HorizontalAlignment="Stretch"
                VerticalAlignment="Top"
                Background="Transparent"
                Cursor="TopSide"
                IsVisible="{Binding !IsCollapsed}"
                ZIndex="9" />
            <!--  Corners  -->
            <Border
                Name="TopLeftResizeBorder"
                Width="12"
                Height="12"
                HorizontalAlignment="Left"
                VerticalAlignment="Top"
                Background="Transparent"
                Cursor="TopLeftCorner"
                IsVisible="{Binding !IsCollapsed}"
                ZIndex="10" />
            <Border
                Name="TopRightResizeBorder"
                Width="12"
                Height="12"
                HorizontalAlignment="Right"
                VerticalAlignment="Top"
                Background="Transparent"
                Cursor="TopRightCorner"
                IsVisible="{Binding !IsCollapsed}"
                ZIndex="10" />

            <!--  Main Content Grid - Hidden when collapsed  -->
            <Grid
                x:Name="Root"
                IsVisible="{Binding !IsCollapsed}"
                PointerPressed="Root_PointerPressed">

                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>

                <!--  Chat View  -->
                <Grid Grid.ColumnSpan="2" IsVisible="{Binding IsChatView}">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>

                    <!--  Sidebar Panel  -->
                    <Border
                        x:Name="SidebarPanel"
                        Grid.Row="1"
                        Grid.Column="0"
                        Width="{Binding SidebarWidth}"
                        Background="rgba(33, 35, 39, 0.5)"
                        BorderBrush="Transparent"
                        BorderThickness="0">
                        <Border.Transitions>
                            <Transitions>
                                <DoubleTransition
                                    Easing="LinearEasing"
                                    Property="Width"
                                    Duration="0:0:0.1" />
                            </Transitions>
                        </Border.Transitions>

                        <Border
                            Margin="10"
                            Padding="6"
                            CornerRadius="12"
                            BorderThickness="1"
                            BorderBrush="rgba(255,255,255,0.05)"
                            Background="rgba(19, 19, 19, 0.4)">
                            <Grid RowDefinitions="Auto,*">
                                <!--  Header  -->
                                <Grid
                                    Grid.Row="0"
                                    VerticalAlignment="Center"
                                    Margin="0,4,0,8"
                                    IsVisible="{Binding IsSidebarOpen}">
                                    <TextBlock
                                        Margin="8,6,0,6"
                                        FontSize="15.2"
                                        FontWeight="SemiBold"
                                        Text="History"
                                        Foreground="White" />
                                </Grid>

                                <!--  Navigation Items  -->
                                <ScrollViewer
                                    Grid.Row="1"
                                    Margin="0"
                                    IsVisible="{Binding IsSidebarOpen}"
                                    VerticalScrollBarVisibility="Auto">
                                    <StackPanel Margin="6,0,6,6" Spacing="8">
                                        <ItemsControl ItemsSource="{Binding NavigationItems}">
                                            <ItemsControl.ItemsPanel>
                                                <ItemsPanelTemplate>
                                                    <StackPanel Spacing="6" />
                                                </ItemsPanelTemplate>
                                            </ItemsControl.ItemsPanel>
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <Button
                                                        Padding="10"
                                                        Margin="0"
                                                        HorizontalAlignment="Stretch"
                                                        Background="{Binding IsSelected, Converter={StaticResource NavigationBackgroundConverter}}"
                                                        BorderBrush="Transparent"
                                                        BorderThickness="0"
                                                        CornerRadius="10">
                                                        <Button.Styles>
                                                            <Style Selector="Button:pointerover">
                                                                <Setter Property="Background" Value="#2A303E" />
                                                            </Style>
                                                            <Style Selector="Button:pressed">
                                                                <Setter Property="Background" Value="#252A36" />
                                                            </Style>
                                                        </Button.Styles>
                                                        <Grid>

                                                            <Grid.ColumnDefinitions>
                                                                <ColumnDefinition Width="*" />
                                                                <ColumnDefinition Width="Auto" />
                                                                <ColumnDefinition Width="Auto" />
                                                            </Grid.ColumnDefinitions>

                                                            <!-- Main content area -->
                                                            <Button
                                                                CornerRadius="10"
                                                                Grid.Column="0"
                                                                Padding="0"
                                                                HorizontalAlignment="Stretch"
                                                                HorizontalContentAlignment="Left"
                                                                Background="Transparent"
                                                                BorderThickness="0"
                                                                Command="{Binding $parent[Window].DataContext.SelectNavigationItemCommand}"
                                                                CommandParameter="{Binding}"
                                                                IsVisible="{Binding !IsRenaming}">
                                                                <Button.Resources>
                                                                    <SolidColorBrush x:Key="ButtonBackground" Color="Transparent" />
                                                                    <SolidColorBrush x:Key="ButtonBackgroundPointerOver" Color="Transparent" />
                                                                    <SolidColorBrush x:Key="ButtonBackgroundPressed" Color="Transparent" />
                                                                    <SolidColorBrush x:Key="ButtonBorderBrush" Color="Transparent" />
                                                                    <SolidColorBrush x:Key="ButtonBorderBrushPointerOver" Color="Transparent" />
                                                                    <SolidColorBrush x:Key="ButtonBorderBrushPressed" Color="Transparent" />
                                                                </Button.Resources>
                                                                <StackPanel Spacing="4">
                                                                    <TextBlock
                                                                        FontSize="15.2"
                                                                        FontWeight="Medium"
                                                                        Foreground="White"
                                                                        Text="{Binding Title}"
                                                                        TextTrimming="CharacterEllipsis" />
                                                                    <TextBlock
                                                                        FontSize="13.4"
                                                                        Foreground="{Binding IsSelected, Converter={StaticResource NavigationSecondaryForegroundConverter}}"
                                                                        Text="{Binding LastActivity, StringFormat='{}{0:MMM d, h:mm tt}', TargetNullValue=''}"
                                                                        TextTrimming="CharacterEllipsis" />
                                                                </StackPanel>
                                                            </Button>

                                                            <!-- Rename TextBox -->
                                                            <TextBox
                                                                Grid.Column="0"
                                                                Margin="0"
                                                                Padding="6,4"
                                                                Background="#2A303E"
                                                                BorderBrush="rgba(255,255,255,0.2)"
                                                                BorderThickness="1"
                                                                CornerRadius="8"
                                                                Foreground="White"
                                                                FontSize="15.2"
                                                                IsVisible="{Binding IsRenaming}"
                                                                Text="{Binding EditingTitle, Mode=TwoWay}"
                                                                KeyUp="RenameTextBox_KeyUp" />

                                                            <!-- Edit button -->
                                                            <Button
                                                                Grid.Column="1"
                                                                Width="24"
                                                                Height="24"
                                                                Margin="2"
                                                                Background="Transparent"
                                                                BorderBrush="Transparent"
                                                                Command="{Binding $parent[Window].DataContext.StartRenameCommand}"
                                                                CommandParameter="{Binding}"
                                                                CornerRadius="4"
                                                                IsVisible="{Binding !IsRenaming}"
                                                                ToolTip.Tip="Rename conversation">
                                                                <Button.Resources>
                                                                    <SolidColorBrush x:Key="ButtonBackground" Color="Transparent" />
                                                                    <SolidColorBrush x:Key="ButtonBackgroundPointerOver" Color="Transparent" />
                                                                    <SolidColorBrush x:Key="ButtonBackgroundPressed" Color="Transparent" />
                                                                    <SolidColorBrush x:Key="ButtonBorderBrush" Color="Transparent" />
                                                                    <SolidColorBrush x:Key="ButtonBorderBrushPointerOver" Color="Transparent" />
                                                                    <SolidColorBrush x:Key="ButtonBorderBrushPressed" Color="Transparent" />
                                                                </Button.Resources>
                                                                <Image
                                                                    Width="12"
                                                                    Height="12"
                                                                    Source="{SvgImage /Assets/edit.svg}" />
                                                            </Button>

                                                            <!-- Delete button -->
                                                            <Button
                                                                Grid.Column="2"
                                                                Width="24"
                                                                Height="24"
                                                                Margin="2"
                                                                Background="Transparent"
                                                                BorderBrush="Transparent"
                                                                Command="{Binding $parent[Window].DataContext.DeleteConversationCommand}"
                                                                CommandParameter="{Binding}"
                                                                CornerRadius="4"
                                                                IsVisible="{Binding !IsRenaming}"
                                                                ToolTip.Tip="Delete conversation">
                                                                <Button.Resources>
                                                                    <SolidColorBrush x:Key="ButtonBackground" Color="Transparent" />
                                                                    <SolidColorBrush x:Key="ButtonBackgroundPointerOver" Color="Transparent" />
                                                                    <SolidColorBrush x:Key="ButtonBackgroundPressed" Color="Transparent" />
                                                                    <SolidColorBrush x:Key="ButtonBorderBrush" Color="Transparent" />
                                                                    <SolidColorBrush x:Key="ButtonBorderBrushPointerOver" Color="Transparent" />
                                                                    <SolidColorBrush x:Key="ButtonBorderBrushPressed" Color="Transparent" />
                                                                </Button.Resources>
                                                                <Image
                                                                    Width="12"
                                                                    Height="12"
                                                                    Source="{SvgImage /Assets/trash.svg}" />
                                                            </Button>

                                                            <!-- Rename buttons -->
                                                            <StackPanel
                                                                Grid.Column="1"
                                                                Grid.ColumnSpan="2"
                                                                Margin="2"
                                                                Orientation="Horizontal"
                                                                Spacing="4"
                                                                IsVisible="{Binding IsRenaming}">
                                                                <Button
                                                                    Width="24"
                                                                    Height="24"
                                                                    Background="#3B82F6"
                                                                    BorderThickness="0"
                                                                    Command="{Binding $parent[Window].DataContext.ConfirmRenameCommand}"
                                                                    CommandParameter="{Binding}"
                                                                    CornerRadius="4"
                                                                    ToolTip.Tip="Confirm rename">
                                                                    <Image
                                                                        Width="14"
                                                                        Height="14"
                                                                        Source="{SvgImage /Assets/check.svg}" />
                                                                </Button>
                                                                <Button
                                                                    Width="24"
                                                                    Height="24"
                                                                    Background="#374151"
                                                                    BorderThickness="0"
                                                                    Command="{Binding $parent[Window].DataContext.CancelRenameCommand}"
                                                                    CommandParameter="{Binding}"
                                                                    CornerRadius="4"
                                                                    ToolTip.Tip="Cancel rename">
                                                                    <Image
                                                                        Width="14"
                                                                        Height="14"
                                                                        Source="{SvgImage /Assets/cancel.svg}" />
                                                                </Button>
                                                            </StackPanel>
                                                        </Grid>
                                                    </Button>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>

                                    </StackPanel>
                                </ScrollViewer>
                            </Grid>
                        </Border>
                    </Border>

                    <Border
                        Grid.Row="1"
                        Grid.Column="2"
                        Margin="0"
                        Background="rgba(33, 35, 39, 0.5)"
                        CornerRadius="0">
                        <Grid
                            Margin="0,10,0,0"
                            Background="Transparent"
                            RowDefinitions="*,Auto">

                            <!-- Scroll to Bottom Button - Absolutely positioned -->
                            <Button
                                Grid.Row="0"
                                Width="160"
                                Height="40"
                                Margin="0,0,0,20"
                                HorizontalAlignment="Center"
                                VerticalAlignment="Bottom"
                                Background="rgba(59, 130, 246, 0.9)"
                                CornerRadius="20"
                                IsVisible="{Binding ShowScrollToBottom}"
                                Click="ScrollToBottomButton_Click"
                                ZIndex="100">
                                <Button.Resources>
                                    <SolidColorBrush x:Key="ButtonBackground" Color="#3B82F6" Opacity="0.9" />
                                    <SolidColorBrush x:Key="ButtonBackgroundPointerOver" Color="#3B82F6" />
                                    <SolidColorBrush x:Key="ButtonBackgroundPressed" Color="#3470F2" />
                                </Button.Resources>
                                <Button.Styles>
                                    <Style Selector="Button:pointerover">
                                        <Setter Property="Background" Value="rgba(59, 130, 246, 1)" />
                                    </Style>
                                    <Style Selector="Button:pressed">
                                        <Setter Property="Background" Value="rgba(52, 112, 242, 1)" />
                                    </Style>
                                </Button.Styles>
                                <StackPanel Orientation="Horizontal" Spacing="8">
                                    <svg:Svg
                                        Width="16"
                                        Height="16"
                                        Path="/Assets/chevron-down.svg"
                                        VerticalAlignment="Center"
                                        Css="svg path { stroke: white !important; }" />
                                    <TextBlock
                                        Text="Scroll to bottom"
                                        FontSize="15.2"
                                        FontWeight="Medium"
                                        Foreground="White"
                                        VerticalAlignment="Center" />
                                </StackPanel>
                            </Button>

                            <StackPanel
                                Margin="20,5,5,5"
                                HorizontalAlignment="Left"
                                VerticalAlignment="Top"
                                Orientation="Horizontal"
                                Spacing="2">
                                <Button
                                    Width="40"
                                    Height="40"
                                    Background="rgba(19, 19, 19, 0.4)"
                                    Classes="icon-btn"
                                    Command="{Binding ToggleSidebarCommand}"
                                    CornerRadius="100">
                                    <Image
                                        Width="20"
                                        Height="20"
                                        Source="{SvgImage /Assets/history.svg}" />
                                </Button>
                                <Button
                                    Width="40"
                                    Height="40"
                                    Background="rgba(19, 19, 19, 0.4)"
                                    Classes="icon-btn"
                                    Command="{Binding NavigateToSettingsCommand}"
                                    CornerRadius="100">
                                    <Image
                                        Width="20"
                                        Height="20"
                                        Source="{SvgImage /Assets/settings.svg}" />
                                </Button>
                                <Button
                                    Width="40"
                                    Height="40"
                                    Background="rgba(19, 19, 19, 0.4)"
                                    Classes="icon-btn"
                                    Command="{Binding CreateNewChatCommand}"
                                    CornerRadius="100">
                                    <Image
                                        Width="20"
                                        Height="20"
                                        Source="{SvgImage /Assets/add.svg}" />
                                </Button>
                            </StackPanel>

                            <StackPanel
                                Margin="5,5,20,5"
                                HorizontalAlignment="Right"
                                VerticalAlignment="Top"
                                Orientation="Horizontal"
                                Spacing="8">
                                <!-- Server Status Indicator with Text -->
                                <Border
                                    Background="rgba(19, 19, 19, 0.6)"
                                    CornerRadius="20"
                                    Padding="10,8"
                                    VerticalAlignment="Center">
                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                        <Border
                                            Width="10"
                                            Height="10"
                                            CornerRadius="5"
                                            Background="{Binding ServerStatusColor}"
                                            VerticalAlignment="Center" />
                                        <TextBlock
                                            Text="{Binding IsServerOnline, Converter={x:Static conv:ServerStatusTextConverter.Instance}}"
                                            FontSize="14"
                                            FontWeight="Medium"
                                            Foreground="White"
                                            VerticalAlignment="Center" />
                                    </StackPanel>
                                </Border>
                                <Button
                                    Background="Transparent"
                                    Classes="icon-btn"
                                    Click="MinimizeButton_Click"
                                    CornerRadius="100">
                                    <TextBlock FontSize="15.2" Text="-" />
                                </Button>
                                <Button
                                    Background="Transparent"
                                    Classes="icon-btn"
                                    Click="CloseButton_Click"
                                    CornerRadius="100">
                                    <TextBlock FontSize="15.2" Text="x" />
                                </Button>
                            </StackPanel>

                            <!-- Empty Chat Welcome -->
                            <Grid
                                Grid.Row="0"
                                Margin="0,40,10,80"
                                IsHitTestVisible="False"
                                IsVisible="{Binding Messages.Count, Converter={StaticResource ZeroToBoolConverter}}"
                                ZIndex="5">
                                <StackPanel
                                    HorizontalAlignment="Center"
                                    VerticalAlignment="Center"
                                    Spacing="12"
                                    Width="380">
                                        <TextBlock
                                            Text="Welcome to Baiss"
                                            FontSize="22.4"
                                            FontWeight="SemiBold"
                                            Foreground="White"
                                            HorizontalAlignment="Center" />
                                        <TextBlock
                                            Text="Ask a question, paste a brief description, or upload files. Baiss handles the rest."
                                            FontSize="15.2"
                                            Margin="0,4,0,0"
                                            Foreground="#9EA8C0"
                                            TextAlignment="Center"
                                            TextWrapping="Wrap" />
                                        <Border
                                            HorizontalAlignment="Center"
                                            Padding="12,6"
                                            CornerRadius="10"
                                            Background="rgba(59,130,246,0.12)">
                                            <TextBlock
                                                Text="Start typing below"
                                                Foreground="#BCD5FF"
                                                FontSize="15.2"
                                                HorizontalAlignment="Center" />
                                        </Border>
                                </StackPanel>
                            </Grid>

                            <ScrollViewer
                                x:Name="ChatScrollViewer"
                                Grid.Row="0"
                                Margin="0,40,10,0"
                                HorizontalScrollBarVisibility="Disabled"
                                VerticalScrollBarVisibility="Auto"
                                IsVisible="{Binding Messages.Count, Converter={StaticResource NonZeroToBoolConverter}}">
                                <ItemsControl ItemsSource="{Binding Messages}">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <StackPanel Spacing="12" />
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                        <Grid HorizontalAlignment="Stretch">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*" />
                                            </Grid.ColumnDefinitions>

                                            <StackPanel Spacing="5" HorizontalAlignment="Stretch">
                                                <Border
                                                    x:Name="Bubble"
                                                    Margin="0,5,0,5"
                                                    HorizontalAlignment="{Binding IsMine, Converter={StaticResource MessageAlignmentConverter}}"
                                                    Background="{Binding IsMine, Converter={StaticResource MessageBackgroundConverter}}"
                                                    CornerRadius="10"
                                                    Padding="10"
                                                    ClipToBounds="False">
                                                    <Border.MaxWidth>
                                                        <MultiBinding Converter="{StaticResource MessageMaxWidthConverter}">
                                                            <Binding Path="$parent[Window].Bounds.Width" />
                                                            <Binding Path="IsMine" />
                                                        </MultiBinding>
                                                    </Border.MaxWidth>
                                                    <StackPanel Spacing="2">
                                                        <ItemsControl
                                                            IsVisible="{Binding !IsLoadingMessage}"
                                                            ItemsSource="{Binding MessageSegments}">
                                                            <ItemsControl.ItemsPanel>
                                                                <ItemsPanelTemplate>
                                                                    <StackPanel Spacing="8" />
                                                                </ItemsPanelTemplate>
                                                            </ItemsControl.ItemsPanel>
                                                            <ItemsControl.DataTemplates>
                                                                <DataTemplate DataType="models:TextMessageSegment">
                                                                    <views:MessageContentView
                                                                        Padding="0"
                                                                        MessageContent="{Binding Text}"
                                                                        IsMine="{Binding IsMine}"
                                                                        HorizontalAlignment="Stretch" />
                                                                </DataTemplate>
                                                                <DataTemplate DataType="models:ThinkingMessageSegment">
                                                                    <Border
                                                                        Margin="0,2,0,0"
                                                                        Background="#161A23"
                                                                        BorderBrush="#2E3A68"
                                                                        BorderThickness="1"
                                                                        CornerRadius="8"
                                                                        Padding="10">
                                                                        <StackPanel>
                                                                            <ToggleButton
                                                                                Classes="thinking-toggle"
                                                                                Background="Transparent"
                                                                                BorderBrush="Transparent"
                                                                                BorderThickness="0"
                                                                                Focusable="False"
                                                                                HorizontalAlignment="Stretch"
                                                                                IsChecked="{Binding IsExpanded, Mode=TwoWay}"
                                                                                Padding="0">
                                                                                <Grid ColumnDefinitions="Auto,*" VerticalAlignment="Center">
                                                                                    <svg:Svg
                                                                                        Grid.Column="0"
                                                                                        Width="16"
                                                                                        Height="16"
                                                                                        Margin="0,0,8,0"
                                                                                        Path="{Binding IsExpanded, Converter={StaticResource ExpandedToArrowConverter}}" />
                                                                                    <TextBlock
                                                                                        Grid.Column="1"
                                                                                        Text="Searching"
                                                                                        VerticalAlignment="Center"
                                                                                        Foreground="#E5EDFF"
                                                                                        FontWeight="SemiBold"
                                                                                        TextWrapping="Wrap" />
                                                                                </Grid>
                                                                            </ToggleButton>
                                                                            <Border
                                                                                Margin="0,8,0,0"
                                                                                Padding="10"
                                                                                Background="#0F172A"
                                                                                CornerRadius="6"
                                                                                IsVisible="{Binding IsExpanded}">
                                                                                <TextBlock
                                                                                    Text="{Binding DisplayText}"
                                                                                    TextWrapping="Wrap"
                                                                                    FontFamily="Consolas, 'Cascadia Code', 'Courier New', 'Segoe UI'"
                                                                                    Foreground="#CBD5F5" />
                                                                            </Border>
                                                                        </StackPanel>
                                                                    </Border>
                                                                </DataTemplate>
                                                                
                                                                <!-- Code Execution Segment Template -->
                                                                <DataTemplate DataType="models:CodeExecutionMessageSegment">
                                                                    <Border
                                                                        Margin="0,2,0,0"
                                                                        Background="rgba(255,255,255,0.1)"
                                                                        BorderBrush="rgba(128,128,128,0.3)"
                                                                        BorderThickness="1"
                                                                        CornerRadius="8"
                                                                        Padding="10">
                                                                        <StackPanel>
                                                                            <ToggleButton
                                                                                Classes="thinking-toggle"
                                                                                Background="Transparent"
                                                                                BorderBrush="Transparent"
                                                                                BorderThickness="0"
                                                                                Focusable="False"
                                                                                HorizontalAlignment="Stretch"
                                                                                IsChecked="{Binding IsExpanded, Mode=TwoWay}"
                                                                                Padding="0">
                                                                                <Grid ColumnDefinitions="Auto,*,Auto" VerticalAlignment="Center">
                                                                                    <svg:Svg
                                                                                        Grid.Column="0"
                                                                                        Width="16"
                                                                                        Height="16"
                                                                                        Margin="0,0,8,0"
                                                                                        Path="{Binding IsExpanded, Converter={StaticResource ExpandedToArrowConverter}}" />
                                                                                    <TextBlock
                                                                                        Grid.Column="1"
                                                                                        Text="Running code"
                                                                                        VerticalAlignment="Center"
                                                                                        Foreground="#E5EDFF"
                                                                                        FontWeight="SemiBold"
                                                                                        TextWrapping="Wrap" />
                                                                                    <Border
                                                                                        Grid.Column="2"
                                                                                        Background="{Binding StatusColor}"
                                                                                        CornerRadius="4"
                                                                                        Padding="6,2">
                                                                                        <TextBlock
                                                                                            Text="{Binding StatusText}"
                                                                                            Foreground="White"
                                                                                            FontSize="11"
                                                                                            FontWeight="SemiBold" />
                                                                                    </Border>
                                                                                </Grid>
                                                                            </ToggleButton>
                                                                            
                                                                            <!-- Code Display (Expanded) -->
                                                                            <Border
                                                                                Margin="0,8,0,0"
                                                                                Padding="10"
                                                                                Background="rgba(128,128,128,0.2)"
                                                                                CornerRadius="6"
                                                                                IsVisible="{Binding IsExpanded}">
                                                                                <StackPanel Spacing="8">
                                                                                    <TextBlock
                                                                                        Text="Code:"
                                                                                        Foreground="#94A3B8"
                                                                                        FontSize="11"
                                                                                        FontWeight="SemiBold" />
                                                                                    <SelectableTextBlock
                                                                                        Text="{Binding Code}"
                                                                                        TextWrapping="Wrap"
                                                                                        FontFamily="Consolas, 'Cascadia Code', 'Courier New', monospace"
                                                                                        FontSize="12"
                                                                                        Foreground="#CBD5F5" />
                                                                                    
                                                                                    <!-- Output (if available) -->
                                                                                    <StackPanel
                                                                                        IsVisible="{Binding HasOutput}"
                                                                                        Spacing="4">
                                                                                        <TextBlock
                                                                                            Text="Output:"
                                                                                            Foreground="#94A3B8"
                                                                                            FontSize="11"
                                                                                            FontWeight="SemiBold"
                                                                                            Margin="0,4,0,0" />
                                                                                        <Border
                                                                                            Background="rgba(128,128,128,0.15)"
                                                                                            CornerRadius="4"
                                                                                            Padding="8">
                                                                                            <SelectableTextBlock
                                                                                                Text="{Binding Output}"
                                                                                                TextWrapping="Wrap"
                                                                                                FontFamily="Consolas, 'Cascadia Code', 'Courier New', monospace"
                                                                                                FontSize="12"
                                                                                                Foreground="{Binding StatusColor}" />
                                                                                        </Border>
                                                                                    </StackPanel>
                                                                                </StackPanel>
                                                                            </Border>
                                                                        </StackPanel>
                                                                    </Border>
                                                                </DataTemplate>
                                                            </ItemsControl.DataTemplates>
                                                        </ItemsControl>
                                                        <StackPanel Orientation="Horizontal"
                                                                    Spacing="8"
                                                                    IsVisible="{Binding IsLoadingMessage}">
                                                            <Grid Width="31"
                                                                  Height="31"
                                                                  HorizontalAlignment="Left"
                                                                  VerticalAlignment="Center">
                                                                <svg:Svg Path="/Assets/chat-loader.svg"
                                                                         Width="31"
                                                                         Height="31"
                                                                         RenderTransformOrigin="0.5,0.5">
                                                                    <svg:Svg.Styles>
                                                                        <Style Selector="svg|Svg">
                                                                            <Style.Animations>
                                                                                <Animation Duration="0:0:1.2" IterationCount="Infinite">
                                                                                    <KeyFrame Cue="0%">
                                                                                        <Setter Property="RotateTransform.Angle" Value="0" />
                                                                                    </KeyFrame>
                                                                                    <KeyFrame Cue="100%">
                                                                                        <Setter Property="RotateTransform.Angle" Value="360" />
                                                                                    </KeyFrame>
                                                                                </Animation>
                                                                            </Style.Animations>
                                                                        </Style>
                                                                </svg:Svg.Styles>
                                                                    <svg:Svg.RenderTransform>
                                                                        <RotateTransform CenterX="15" CenterY="15" />
                                                                    </svg:Svg.RenderTransform>
                                                                </svg:Svg>

                                                                <svg:Svg Path="/Assets/chat-barian-loader.svg"
                                                                         Width="14"
                                                                         Height="14"
                                                                         HorizontalAlignment="Center"
                                                                         VerticalAlignment="Center" />
                                                            </Grid>

                                                                <TextBlock Text="Answering..."
                                                                           VerticalAlignment="Center"
                                                                           FontSize="15.2"
                                                                           Foreground="#ffffffff" />
                                                        </StackPanel>

                                                        <!-- Retrieved Paths (inside bubble for consistent width) -->
                                                        <Border
                                                            IsVisible="{Binding HasPaths}"
                                                            Margin="0,8,0,0"
                                                            Background="#161A23"
                                                            BorderBrush="#2E3A68"
                                                            BorderThickness="1"
                                                            CornerRadius="8"
                                                            Padding="10">
                                                            <StackPanel Spacing="6">
                                                                <ToggleButton
                                                                    Classes="thinking-toggle"
                                                                    Background="Transparent"
                                                                    BorderBrush="Transparent"
                                                                    BorderThickness="0"
                                                                    Focusable="False"
                                                                    HorizontalAlignment="Stretch"
                                                                    IsChecked="{Binding IsPathsExpanded, Mode=TwoWay}"
                                                                    Padding="0">
                                                                    <Grid ColumnDefinitions="Auto,*,Auto" VerticalAlignment="Center">
                                                                        <svg:Svg
                                                                            Grid.Column="0"
                                                                            Width="16"
                                                                            Height="16"
                                                                            Margin="0,0,8,0"
                                                                            Path="{Binding IsPathsExpanded, Converter={StaticResource ExpandedToArrowConverter}}" />
                                                                        <TextBlock
                                                                            Grid.Column="1"
                                                                            Text="Retrieved Paths"
                                                                            VerticalAlignment="Center"
                                                                            Foreground="#E5EDFF"
                                                                            FontWeight="SemiBold"
                                                                            TextWrapping="Wrap" />
                                                                        <Border
                                                                            Grid.Column="2"
                                                                            Background="#1E293B"
                                                                            CornerRadius="999"
                                                                            Padding="6,0"
                                                                            Margin="8,0,0,0">
                                                                            <TextBlock
                                                                                Text="{Binding PathsCount}"
                                                                                VerticalAlignment="Center"
                                                                                Foreground="#E5EDFF"
                                                                                FontSize="15.2"
                                                                                FontWeight="SemiBold" />
                                                                        </Border>
                                                                    </Grid>
                                                                </ToggleButton>

                                                                <ItemsControl
                                                                    ItemsSource="{Binding Paths}"
                                                                    IsVisible="{Binding IsPathsExpanded}">
                                                                    <ItemsControl.ItemsPanel>
                                                                        <ItemsPanelTemplate>
                                                                            <StackPanel Spacing="6" />
                                                                        </ItemsPanelTemplate>
                                                                    </ItemsControl.ItemsPanel>
                                                                    <ItemsControl.ItemTemplate>
                                                                        <DataTemplate>
                                                                            <Border
                                                                                Padding="12"
                                                                                Background="#0F172A"
                                                                                CornerRadius="8"
                                                                                BorderBrush="#1E3A8A"
                                                                                BorderThickness="1">
                                                                                <StackPanel Spacing="6">
                                                                                    <Grid ColumnDefinitions="*,Auto">
                                                                                        <TextBlock
                                                                                            Grid.Column="0"
                                                                                            Text="{Binding DisplayFileName}"
                                                                                            FontSize="15.2"
                                                                                            FontWeight="SemiBold"
                                                                                            Foreground="#E5EDFF"
                                                                                            TextTrimming="CharacterEllipsis" />
                                                                                        <Border
                                                                                            Grid.Column="1"
                                                                                            Background="#14532D"
                                                                                            CornerRadius="4"
                                                                                            Padding="6,2"
                                                                                            HorizontalAlignment="Right">
                                                                                            <TextBlock
                                                                                                Text="{Binding FormattedScore}"
                                                                                                FontSize="15.2"
                                                                                                FontWeight="SemiBold"
                                                                                                Foreground="#86EFAC" />
                                                                                        </Border>
                                                                                    </Grid>
                                                                                    <SelectableTextBlock
                                                                                        Text="{Binding Path}"
                                                                                        FontFamily="Consolas, 'Cascadia Code', 'Courier New', 'Segoe UI'"
                                                                                        FontSize="15.2"
                                                                                        TextWrapping="Wrap"
                                                                                        Foreground="#CBD5F5" />
                                                                                </StackPanel>
                                                                            </Border>
                                                                        </DataTemplate>
                                                                    </ItemsControl.ItemTemplate>
                                                                </ItemsControl>
                                                            </StackPanel>
                                                        </Border>
                                                    </StackPanel>
                                                </Border>
                                                
                                                <!-- Copy Button (below message) -->
                                                <Button
                                                    Height="24"
                                                    Margin="20,0,10,0"
                                                    Padding="4,2"
                                                    HorizontalAlignment="{Binding IsMine, Converter={StaticResource CopyButtonAlignmentConverter}}"
                                                    Background="Transparent"
                                                    BorderThickness="0"
                                                    Opacity="0.4"
                                                    Cursor="Hand"
                                                    Command="{Binding DataContext.CopyMessageCommand, ElementName=MainWin}"
                                                    CommandParameter="{Binding}"
                                                    ToolTip.Tip="Copy message">
                                                    <Button.Styles>
                                                        <Style Selector="Button:pointerover">
                                                            <Setter Property="Opacity" Value="1" />
                                                        </Style>
                                                        <Style Selector="Button:pointerover /template/ ContentPresenter">
                                                            <Setter Property="Background" Value="Transparent" />
                                                        </Style>
                                                    </Button.Styles>
                                                    <StackPanel Orientation="Horizontal" Spacing="4">
                                                        <Image
                                                            Width="14"
                                                            Height="14"
                                                            VerticalAlignment="Center"
                                                            Source="{SvgImage /Assets/copy.svg}" />
                                                        <TextBlock
                                                            Text="Copy"
                                                            VerticalAlignment="Center"
                                                            FontSize="12"
                                                            Foreground="White" />
                                                    </StackPanel>
                                                </Button>

                                                <!-- Sources Section -->
                                                <Border
                                                    IsVisible="{Binding HasSources}"
                                                    Margin="5,5,5,0"
                                                    HorizontalAlignment="{Binding IsMine, Converter={StaticResource MessageAlignmentConverter}}"
                                                    Background="{Binding IsMine, Converter={StaticResource MessageBackgroundConverter}}"
                                                    CornerRadius="10"
                                                    Opacity="0.9">
                                                    <Border.MaxWidth>
                                                        <MultiBinding Converter="{StaticResource MessageMaxWidthConverter}">
                                                            <Binding Path="$parent[Window].Bounds.Width" />
                                                            <Binding Path="IsMine" />
                                                        </MultiBinding>
                                                    </Border.MaxWidth>

                                                    <StackPanel>
                                                        <!-- Sources Header (Clickable) -->
                                                        <Button
                                                            Background="Transparent"
                                                            BorderBrush="Transparent"
                                                            BorderThickness="0"
                                                            Padding="15,10"
                                                            Command="{Binding $parent[Window].DataContext.ShowSourcesInSidebarCommand}"
                                                            CommandParameter="{Binding}">
                                                            <Button.Styles>
                                                                <Style Selector="Button:pointerover /template/ ContentPresenter">
                                                                    <Setter Property="Background" Value="Transparent" />
                                                                </Style>
                                                                <Style Selector="Button:pressed /template/ ContentPresenter">
                                                                    <Setter Property="Background" Value="Transparent" />
                                                                </Style>
                                                            </Button.Styles>
                                                            <StackPanel Orientation="Horizontal" Spacing="10">
                                                                <TextBlock
                                                                    Text="{Binding SourcesSummary}"
                                                                    FontSize="15.2"
                                                                    FontWeight="Medium"
                                                                    VerticalAlignment="Center"
                                                                    Foreground="#E0E0E0" />
                                                            </StackPanel>
                                                        </Button>

                                                        <!-- Sources Details (Expandable) -->
                                                        <ItemsControl
                                                            ItemsSource="{Binding Sources}"
                                                            IsVisible="{Binding IsSourcesExpanded}"
                                                            Margin="15,0,15,10">
                                                            <ItemsControl.ItemTemplate>
                                                                <DataTemplate>
                                                                    <!-- File Container with Gray Border -->
                                                                    <Border
                                                                        Margin="0,5,0,0"
                                                                        Padding="8"
                                                                        Background="rgba(255,255,255,0.02)"
                                                                        BorderBrush="rgba(128,128,128,0.3)"
                                                                        BorderThickness="1"
                                                                        CornerRadius="8">
                                                                        <StackPanel Spacing="0">
                                                                            <!-- File Header -->
                                                                            <Border
                                                                                Padding="10,8"
                                                                                Background="Transparent"
                                                                                CornerRadius="8,8,0,0">
                                                                                <StackPanel Orientation="Horizontal" Spacing="8">
                                                                                    <!-- File Icon -->
                                                                                    <Image
                                                                                        Width="19"
                                                                                        Height="19"
                                                                                        VerticalAlignment="Center"
                                                                                        Source="{SvgImage /Assets/file-text-white.svg}" />
                                                                                    <!-- File Name (extracted from path) -->
                                                                                    <SelectableTextBlock
                                                                                        FontSize="15.2"
                                                                                        FontWeight="SemiBold"
                                                                                        Text="{Binding Converter={StaticResource FileNameConverter}}"
                                                                                        TextWrapping="Wrap"
                                                                                        VerticalAlignment="Center"
                                                                                        Foreground="#E0E0E0" />
                                                                                </StackPanel>
                                                                            </Border>

                                                                            <!-- Overview Section -->
                                                                            <Border
                                                                                Padding="10"
                                                                                Background="rgba(128,128,128,0.2)"
                                                                                CornerRadius="8">
                                                                                <StackPanel Spacing="6">
                                                                                    <!-- Overview Header -->
                                                                                    <StackPanel Orientation="Horizontal" Spacing="6">
                                                                                        <!-- Analysis Icon -->
                                                                                        <Image
                                                                                            Width="14"
                                                                                            Height="14"
                                                                                            VerticalAlignment="Center"
                                                                                            Source="{SvgImage /Assets/card-search.svg}" />
                                                                                        <TextBlock
                                                                                            Text="Overview"
                                                                                            FontSize="15.2"
                                                                                            FontWeight="Medium"
                                                                                            VerticalAlignment="Center"
                                                                                            Foreground="#B0B0B0" />
                                                                                    </StackPanel>
                                                                                    <!-- Content Preview -->
                                                                                    <SelectableTextBlock
                                                                                        FontSize="15.2"
                                                                                        Text="{Binding FileChunk.FullText}"
                                                                                        TextWrapping="Wrap"
                                                                                        MaxLines="4"
                                                                                        Opacity="0.9"
                                                                                        Foreground="#C0C0C0" />
                                                                                </StackPanel>
                                                                            </Border>
                                                                        </StackPanel>
                                                                    </Border>
                                                                </DataTemplate>
                                                            </ItemsControl.ItemTemplate>
                                                        </ItemsControl>
                                                    </StackPanel>
                                                </Border>

                                            </StackPanel>
                                        </Grid>
                                    </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </ScrollViewer>

                            <Grid
                                Grid.Row="1"
                                Margin="10,0,10,15"
                                Background="Transparent">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>

                                <Button
                                    Grid.Column="1"
                                    Width="50"
                                    Height="50"
                                    Margin="5,0,0,0"
                                    HorizontalAlignment="Center"
                                    VerticalAlignment="Bottom"
                                    Background="Azure"
                                    Classes="menu-btn"
                                    ClipToBounds="True"
                                    Command="{Binding ToggleCollapseCommand}"
                                    CornerRadius="40"
                                    Padding="5"
                                    ZIndex="100"
                                    HorizontalContentAlignment="Center"
                                    VerticalContentAlignment="Center">
                                    <Border
                                        HorizontalAlignment="Center"
                                        VerticalAlignment="Center"
                                        ClipToBounds="True"
                                        CornerRadius="20"
                                        Width="40"
                                        Height="40">
                                        <Border.Background>
                                            <ImageBrush Source="/Assets/logo.ico" />
                                        </Border.Background>
                                    </Border>
                                </Button>
                                <Border
                                    Grid.Column="0"
                                    Padding="5,10"
                                    Background="rgba(255,255,255,0.1)"
                                    CornerRadius="20">
                                    <Grid
                                        Background="Transparent"
                                        ColumnDefinitions="*,50"
                                        RowDefinitions="Auto,*,Auto">
                                        <ScrollViewer
                                            Grid.Row="0"
                                            Grid.ColumnSpan="2"
                                            Margin="5,0,5,5"
                                            HorizontalScrollBarVisibility="Hidden"
                                            VerticalScrollBarVisibility="Disabled">
                                            <ItemsControl ItemsSource="{Binding Datasets}">
                                                <ItemsControl.ItemsPanel>
                                                    <ItemsPanelTemplate>
                                                        <StackPanel Orientation="Horizontal" />
                                                    </ItemsPanelTemplate>
                                                </ItemsControl.ItemsPanel>
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <Border
                                                            Margin="5,0"
                                                            Padding="10,5"
                                                            Background="White"
                                                            CornerRadius="15">
                                                            <StackPanel
                                                                VerticalAlignment="Center"
                                                                Orientation="Horizontal"
                                                                Spacing="2">
                                                                <svg:Svg
                                                                    Width="20"
                                                                    Height="20"
                                                                    Path="{Binding Icon}" />
                                                                <TextBlock Foreground="Black" Text="{Binding Name}" />
                                                                <!-- Updated Remove Button -->
                                                                <Button
                                                                    Background="Transparent"
                                                                    Classes="icon-btn"
                                                                    Command="{Binding DataContext.RemoveFileCommand, ElementName=MainWin}"
                                                                    CommandParameter="{Binding}"
                                                                    Padding="2"
                                                                    Margin="5,0,0,0">
                                                                    <svg:Svg
                                                                        Width="14"
                                                                        Height="14"
                                                                        Path="/Assets/remove-file.svg" />
                                                                </Button>
                                                            </StackPanel>
                                                        </Border>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </ScrollViewer>
                                        <TextBox
                                            x:Name="MessageInputBox"
                                            Background="Transparent"
                                            Grid.Row="1"
                                            Grid.Column="0"
                                            Grid.ColumnSpan="2"
                                            MinHeight="40"
                                            MaxHeight="100"
                                            VerticalContentAlignment="Center"
                                            AcceptsReturn="False"
                                            Classes="chat-input"
                                            IsEnabled="{Binding IsBotTyping, Converter={StaticResource NegateBool}}"
                                            KeyUp="MessageInputBox_KeyUp"
                                            Text="{Binding NewMessage, Mode=TwoWay}"
                                            TextWrapping="Wrap"
                                            Watermark="Type a message or drag &amp; drop files...">
                                            <TextBox.Resources>
                                                <SolidColorBrush x:Key="TextControlBackground" Color="Transparent" />
                                                <SolidColorBrush x:Key="TextControlBackgroundPointerOver" Color="Transparent" />
                                                <SolidColorBrush x:Key="TextControlBackgroundFocused" Color="Transparent" />
                                                <SolidColorBrush x:Key="TextControlBackgroundDisabled" Color="Transparent" />
                                                <SolidColorBrush x:Key="TextControlBorderBrushDisabled" Color="Transparent" />
                                                <SolidColorBrush x:Key="TextControlBorderBrush" Color="Transparent" />
                                                <SolidColorBrush x:Key="TextControlBorderBrushPointerOver" Color="Transparent" />
                                                <SolidColorBrush x:Key="TextControlBorderBrushFocused" Color="Transparent" />
                                            </TextBox.Resources>
                                        </TextBox>
                                            <Grid Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="2" Background="Transparent" x:Name="MessageInputBoxActions">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto" />
                                                    <ColumnDefinition Width="Auto" />
                                                    <ColumnDefinition Width="*" />
                                                    <ColumnDefinition Width="Auto" />
                                                </Grid.ColumnDefinitions>
                                            <!-- Add File Button -->
                                            <Button
                                                Grid.Column="0"
                                                Width="40"
                                                Height="40"
                                                Margin="5,0,5,0"
                                                HorizontalAlignment="Left"
                                                VerticalAlignment="Bottom"
                                                Background="rgba(19, 19, 19, 0.4)"
                                                Command="{Binding AddFileCommand}"
                                                CornerRadius="100"
                                                IsEnabled="{Binding IsBotTyping, Converter={StaticResource NegateBool}}">
                                                <Image
                                                    Width="20"
                                                    Height="20"
                                                    Source="{SvgImage /Assets/plus.svg}" />
                                            </Button>
                                            <!-- Screenshot Button -->
                                            <!-- <Button
                                                Grid.Column="1"
                                                Width="40"
                                                Height="40"
                                                Margin="0,0,5,0"
                                                HorizontalAlignment="Left"
                                                VerticalAlignment="Bottom"
                                                Background="rgba(19, 19, 19, 0.4)"
                                                Command="{Binding CaptureScreenButtonCommand}"
                                                CornerRadius="100"
                                                IsEnabled="{Binding IsBotTyping, Converter={StaticResource NegateBool}}">
                                                <Image
                                                    Width="20"
                                                    Height="20"
                                                    HorizontalAlignment="Center"
                                                    VerticalAlignment="Center"
                                                    Source="{SvgImage /Assets/camera.svg}" />
                                            </Button> -->
                                            <!-- Chat Model Selector -->
                                            <Border
                                                Grid.Column="2"
                                                Height="40"
                                                Margin="5,0,5,0"
                                                Background="rgba(19, 19, 19, 0.4)"
                                                CornerRadius="20"
                                                Padding="8,0"
                                                VerticalAlignment="Bottom"
                                                HorizontalAlignment="Left"
                                                MinWidth="140"
                                                Width="140">
                                                <Grid>
                                                    <ComboBox
                                                        Classes="compact-model-select"
                                                        HorizontalAlignment="Stretch"
                                                        HorizontalContentAlignment="Stretch"
                                                        VerticalAlignment="Center"
                                                        ItemTemplate="{StaticResource CompactChatModelTemplate}"
                                                        ItemsSource="{Binding SettingsViewModel.DownloadedLocalChatModels}"
                                                        MinWidth="140"
                                                        PlaceholderText="Models"
                                                        SelectedItem="{Binding SettingsViewModel.SelectedLocalChatModel}"
                                                        IsVisible="{Binding SettingsViewModel.AIModelProviderScope, Converter={StaticResource ScopeEqualsConverter}, ConverterParameter=local}" />
                                                    <ComboBox
                                                        Classes="compact-model-select"
                                                        HorizontalAlignment="Stretch"
                                                        HorizontalContentAlignment="Stretch"
                                                        VerticalAlignment="Center"
                                                        ItemTemplate="{StaticResource CompactChatModelTemplate}"
                                                        ItemsSource="{Binding SettingsViewModel.AvailableModels}"
                                                        MinWidth="140"
                                                        PlaceholderText="Models"
                                                        SelectedItem="{Binding SettingsViewModel.SelectedHostedChatModel}"
                                                        IsVisible="{Binding SettingsViewModel.AIModelProviderScope, Converter={StaticResource ScopeEqualsConverter}, ConverterParameter=hosted}" />
                                                </Grid>
                                            </Border>
                                            <!-- Send Message Button -->
                                            <Button
                                                Grid.Column="3"
                                                Width="40"
                                                Height="40"
                                                Margin="5,0,5,0"
                                                HorizontalAlignment="Right"
                                                VerticalAlignment="Bottom"
                                                Background="rgba(19, 19, 19, 0.4)"
                                                Command="{Binding SendMessageCommand}"
                                                CornerRadius="100"
                                                IsEnabled="{Binding CanSendMessage}">
                                                <Image
                                                    Width="20"
                                                    Height="20"
                                                    Source="{SvgImage /Assets/send.svg}" />
                                            </Button>
                                        </Grid>
                                    </Grid>
                                </Border>
                            </Grid>

                            <!-- No Models Available Modal -->
                            <Grid IsVisible="{Binding ShowNoModelsModal}"
                                  Background="Transparent"
                                  IsHitTestVisible="False"
                                  ZIndex="2001"
                                  Grid.RowSpan="2">
                                <Border MaxWidth="500"
                                         Background="#00143C"
                                         CornerRadius="12"
                                         Padding="24"
                                         HorizontalAlignment="Center"
                                         VerticalAlignment="Center"
                                         IsHitTestVisible="True">
                                    <StackPanel Spacing="12">
                                        <!-- Title -->
                                        <TextBlock Text="You're almost set."
                                                   FontSize="15.2"
                                                   FontWeight="SemiBold"
                                                   Foreground="White"
                                                   TextAlignment="Center" />

                                        <!-- Description -->
                                        <TextBlock FontSize="15.2"
                                                   Foreground="White"
                                                   TextWrapping="Wrap"
                                                   TextAlignment="Center"
                                                   LineHeight="20">
                                            <Run Text="Go to " />
                                            <Run Text="Settings &gt; AI Models" FontWeight="SemiBold" />
                                            <Run Text=" to download a local model, then come back to chat." />
                                        </TextBlock>
                                    </StackPanel>
                                </Border>
                            </Grid>

                            <!-- Model Error Modal -->
                            <Grid IsVisible="{Binding ShowModelErrorModal}"
                                  Background="Transparent"
                                  IsHitTestVisible="False"
                                  ZIndex="2002"
                                  Grid.RowSpan="2">
                                <Border MaxWidth="400"
                                         Background="#00143C"
                                         CornerRadius="12"
                                         Padding="24"
                                         HorizontalAlignment="Center"
                                         VerticalAlignment="Center"
                                         IsHitTestVisible="True">
                                    <StackPanel Spacing="12">
                                        <TextBlock FontSize="17"
                                                   FontWeight="SemiBold"
                                                   Foreground="White"
                                                   TextAlignment="Center"
                                                   Text="We hit a snag." />
                                        <TextBlock FontSize="15"
                                                   Foreground="#E0E7FF"
                                                   TextWrapping="Wrap"
                                                   TextAlignment="Center"
                                                   LineHeight="22">
                                            <Run Text="Select another model or reconnect this one from " />
                                            <Run Text="Settings &gt; AI Models" FontWeight="SemiBold" />
                                            <Run Text=", then try again." />
                                        </TextBlock>
                                    </StackPanel>
                                </Border>
                            </Grid>

                        </Grid>
                    </Border>

                    <!-- Source Files Sidebar -->
                    <Border
                        Grid.Row="1"
                        Grid.Column="1"
                        Width="{Binding SourceSidebarWidth}"
                        Background="rgba(33, 35, 39, 0.5)"
                        BorderBrush="rgba(255,255,255,0.3)"
                        BorderThickness="0,0,1,0"
                        IsVisible="{Binding IsSourceSidebarOpen}">
                        <Border.Transitions>
                            <Transitions>
                                <DoubleTransition
                                    Easing="LinearEasing"
                                    Property="Width"
                                    Duration="0:0:0.1" />
                            </Transitions>
                        </Border.Transitions>

                        <Border
                            Margin="5"
                            Background="rgba(33, 35, 39, 1)"
                            CornerRadius="10">
                            <Grid RowDefinitions="Auto,*">
                                <!--  Header  -->
                                <Grid
                                    Grid.Row="0"
                                    VerticalAlignment="Center"
                                    ColumnDefinitions="*,Auto"
                                    IsVisible="{Binding IsSourceSidebarOpen}">
                                    <TextBlock
                                        Grid.Column="0"
                                        Margin="15,15,0,15"
                                        VerticalAlignment="Center"
                                        FontWeight="SemiBold"
                                        Text="Source Files" />
                                    <Button
                                        Grid.Column="1"
                                        Margin="5,10"
                                        Background="Transparent"
                                        BorderThickness="0"
                                        Click="CloseSourceSidebar_Click">
                                        <Button.Resources>
                                            <SolidColorBrush x:Key="ButtonBackgroundPointerOver" Color="Transparent" />
                                            <SolidColorBrush x:Key="ButtonBackgroundPressed" Color="Transparent" />
                                            <SolidColorBrush x:Key="ButtonBorderBrushPointerOver" Color="Transparent" />
                                            <SolidColorBrush x:Key="ButtonBorderBrushPressed" Color="Transparent" />
                                        </Button.Resources>
                                        <TextBlock
                                            VerticalAlignment="Center"
                                            FontSize="15.2"
                                            Text="" />
                                    </Button>
                                </Grid>

                                <!--  Source Files List  -->
                                <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                                    <StackPanel Margin="10,0,10,10">
                                        <ItemsControl ItemsSource="{Binding SidebarFiles}">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <Border Background="rgba(255,255,255,0.05)" CornerRadius="8" Margin="0,4" Padding="0" BorderBrush="White" BorderThickness="1">
                                                        <StackPanel>
                                                            <!-- Main File Row -->
                                                            <Grid>
                                                                <Grid.ColumnDefinitions>
                                                                    <ColumnDefinition Width="Auto" />
                                                                    <ColumnDefinition Width="*" />
                                                                    <ColumnDefinition Width="Auto" />
                                                                </Grid.ColumnDefinitions>

                                                                <!-- File Icon and Name -->
                                                                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8" Margin="12,10">
                                                                    <Image Width="16" Height="16" Source="{SvgImage /Assets/file-text-white.svg}" />
                                                                    <StackPanel>
                                                                        <TextBlock
                                                                            FontSize="15.2"
                                                                            FontWeight="Medium"
                                                                            Foreground="#E0E0E0"
                                                                            Text="{Binding DisplayFileName}" />
                                                                        <TextBlock
                                                                            FontSize="15.2"
                                                                            Foreground="#A0A0A0"
                                                                            Text="{Binding ScoreText}" />
                                                                    </StackPanel>
                                                                </StackPanel>

                                                                <!-- Chevron Button -->
                                                                <Button
                                                                    Grid.Column="2"
                                                                    Width="24"
                                                                    Height="24"
                                                                    Margin="12,10"
                                                                    Background="White"
                                                                    BorderThickness="0"
                                                                    CornerRadius="12"
                                                                    Command="{Binding $parent[Window].DataContext.ToggleSourceExpandedCommand}"
                                                                    CommandParameter="{Binding}">
                                                                    <Button.Resources>
                                                                        <SolidColorBrush x:Key="ButtonBackground" Color="White" />
                                                                        <SolidColorBrush x:Key="ButtonBackgroundPointerOver" Color="White" />
                                                                        <SolidColorBrush x:Key="ButtonBackgroundPressed" Color="White" />
                                                                        <SolidColorBrush x:Key="ButtonBorderBrush" Color="Transparent" />
                                                                        <SolidColorBrush x:Key="ButtonBorderBrushPointerOver" Color="Transparent" />
                                                                        <SolidColorBrush x:Key="ButtonBorderBrushPressed" Color="Transparent" />
                                                                    </Button.Resources>
                                                                    <Grid>
                                                                        <Image
                                                                            Width="14"
                                                                            Height="14"
                                                                            IsVisible="{Binding !IsExpanded}"
                                                                            Source="{SvgImage /Assets/chevron-down.svg}" />
                                                                        <Image
                                                                            Width="14"
                                                                            Height="14"
                                                                            IsVisible="{Binding IsExpanded}"
                                                                            Source="{SvgImage /Assets/chevron-up.svg}" />
                                                                    </Grid>
                                                                </Button>
                                                            </Grid>

                                                            <!-- Expandable Overview - Inside same card -->
                                                            <StackPanel
                                                                IsVisible="{Binding IsExpanded}"
                                                                Margin="12,0,12,12">
                                                                <Border
                                                                    Background="rgba(128,128,128,0.2)"
                                                                    CornerRadius="6"
                                                                    Padding="12"
                                                                    Margin="0,8,0,0">
                                                                    <StackPanel>
                                                                        <StackPanel Orientation="Horizontal" Spacing="6" Margin="0,0,0,8">
                                                                            <Image Width="14" Height="14" Source="{SvgImage /Assets/card-search.svg}" />
                                                                            <TextBlock FontSize="15.2" Foreground="#B0B0B0" Text="Overview" FontWeight="Medium" />
                                                                        </StackPanel>

                                                                        <TextBlock
                                                                            FontSize="15.2"
                                                                            Foreground="#C0C0C0"
                                                                            Text="{Binding OverviewText}"
                                                                            TextWrapping="Wrap" />
                                                                    </StackPanel>
                                                                </Border>
                                                            </StackPanel>
                                                        </StackPanel>
                                                    </Border>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </StackPanel>
                                </ScrollViewer>
                            </Grid>
                        </Border>
                    </Border>
                </Grid>

                <!--  Settings View  -->
                <Border
                    Grid.ColumnSpan="2"
                    Margin="0"
                    Background="rgba(33, 35, 39, 0.5)"
                    CornerRadius="0"
                    IsVisible="{Binding IsSettingsView}">
                    <Grid
                        Margin="0,10,0,0"
                        Background="Transparent"
                        RowDefinitions="Auto,*">
                        <!--  Top buttons for settings view  -->
                        <Grid
                            Grid.Row="0"
                            Margin="5"
                            ColumnDefinitions="*,*">
                            <!--  Left side - Back button  -->
                            <StackPanel
                                Grid.Column="0"
                                Margin="15,0,0,0"
                                HorizontalAlignment="Left"
                                VerticalAlignment="Top"
                                Orientation="Horizontal"
                                Spacing="2">
                                <Button
                                    Background="rgba(19, 19, 19, 0.4)"
                                    BorderBrush="rgba(255,255,255,0.05)"
                                    BorderThickness="1"
                                    Classes="icon-btn"
                                    Command="{Binding NavigateBackCommand}"
                                    CornerRadius="25">
                                    <StackPanel Orientation="Horizontal" Spacing="4" VerticalAlignment="Center" HorizontalAlignment="Center">
                                        <Image
                                            Width="16"
                                            Height="16"
                                            VerticalAlignment="Center"
                                            Source="{SvgImage /Assets/chevron-left-white.svg}" />
                                        <TextBlock
                                            VerticalAlignment="Center"
                                            FontSize="15.2"
                                            Text="Back" />
                                    </StackPanel>
                                </Button>
                            </StackPanel>

                            <!--  Right side - Close and minimize buttons  -->
                            <StackPanel
                                Grid.Column="1"
                                Margin="0,0,15,0"
                                HorizontalAlignment="Right"
                                VerticalAlignment="Top"
                                Orientation="Horizontal"
                                Spacing="2">
                                <Button
                                    Background="Transparent"
                                    Classes="icon-btn"
                                    Click="MinimizeButton_Click"
                                    CornerRadius="100">
                                    <TextBlock FontSize="15.2" Text="-" />
                                </Button>
                                <Button
                                    Background="Transparent"
                                    Classes="icon-btn"
                                    Click="CloseButton_Click"
                                    CornerRadius="100">
                                    <TextBlock FontSize="15.2" Text="x" />
                                </Button>
                            </StackPanel>
                        </Grid>

                        <!--  Settings content  -->
                        <views:SettingsView Grid.Row="1" DataContext="{Binding SettingsViewModel}" />
                    </Grid>
                </Border>
            </Grid>

            <!--  Floating Collapse Button - Always visible  -->
            <Border
                Grid.Column="0"
                Width="50"
                Height="50"
                Margin="10"
                HorizontalAlignment="Left"
                VerticalAlignment="Bottom"
                Background="Azure"
                ClipToBounds="True"
                CornerRadius="40"
                Cursor="Hand"
                IsVisible="{Binding IsCollapsed}"
                PointerMoved="FloatingButton_PointerMoved"
                PointerPressed="FloatingButton_PointerPressed"
                PointerReleased="FloatingButton_PointerReleased"
                ZIndex="100">
                <Border
                    Width="40"
                    Height="40"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    ClipToBounds="True"
                    CornerRadius="35">
                    <Image
                        Width="40"
                        Height="40"
                        HorizontalAlignment="Center"
                        VerticalAlignment="Center"
                        Source="/Assets/baiss.logo.png" />
                </Border>
            </Border>
        </Grid>
    </Border>

</Window>


